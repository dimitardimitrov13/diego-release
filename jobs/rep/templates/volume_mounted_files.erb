#!/usr/bin/env bash

<%
  _max_containers = 250
  if_p("diego.rep.max_containers") do |value|
    _max_containers = value
  end
  if _max_containers <= 0
    raise "The max_containers prop should be a positive integer"
  end
%>
max_containers=<%= _max_containers %>

# Define the service binding root directory
volume_mounted_files="/var/vcap/data/rep/shared/garden/volume_mounted_files"

# Calculate the size for the tmpfs (1MB per container)
root_tmpfs_size=$((max_containers * 1))M

# Ensure the root directory is safely removed and recreated
if [ -d "$volume_mounted_files" ]; then
  # Ensure the root directory is unmounted before removing it
  if mountpoint -q "$volume_mounted_files"; then
    fuser -k "$volume_mounted_files"
    umount -l "$volume_mounted_files"
  fi

  sleep 10

  rm -rf "$volume_mounted_files"
fi

mkdir -p "$volume_mounted_files"

# Mount the root tmpfs
mount -t tmpfs -o size="$root_tmpfs_size" tmpfs "$volume_mounted_files" || exit 1

# Set permissions and ownership for the root directory and all subdirectories
chmod 0700 "$volume_mounted_files"
chown vcap:vcap "$volume_mounted_files"
